#!/usr/bin/env bash
# this script for installing nginx on serever and adding a new header
# to the srever

HOSTNAME=$(hostname)

FONFIG_FILE="/etc/nginx/sites-available/default"

# update file index
# sudo apt-get update

# install nginx
# sudo apt-get install -y nginx

# make a backup copy for config file
sudo cp $FONFIG_FILE ${FONFIG_FILE}.bak

# redirect directive
redirect="\\\trewrite ^/redirect_me https://www.youtube.com/watch?v=QH2-TGUlwu4 permanent;"

echo "Hello World!" | sudo tee /var/www/html/index.html > /dev/null

if ! grep -q "/redirect_me" $FONFIG_FILE; then
    sudo sed -i "/server {/a $redirect" /etc/nginx/sites-available/default
fi


echo -e "Ceci n'est pas une page\n" | sudo tee /var/www/html/404.html > /dev/null

if ! grep -q "error_page 404" $FONFIG_FILE; then
    sudo sed -i '/server {/a \\terror_page 404 /404.html;\n\ \ \ \t location = /404.html {\n\ \ \ \ \ \t \t internal;\n\ \ \ \t }' $FONFIG_FILE
fi

header="add_header X-Served-By $HOSTNAME;"
if ! grep -q "add_header X-Served-By" $FONFIG_FILE; then
    sudo sed -i "/server {/a \\\t$header" $FONFIG_FILE
fi

sudo nginx -s reload

sudo service nginx restart
